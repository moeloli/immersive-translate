(()=>{var g={BUILD_TIME:"2025-06-30T08:01:26.000Z",VERSION:"1.18.10",PROD:"1",REDIRECT_URL:"https://dash.immersivetranslate.com/auth-done/",PROD_API:"1",BETA:"0",userscript_domains:'["google.com","translate.googleapis.com","api-edge.cognitive.microsofttranslator.com","edge.microsoft.com","transmart.qq.com","translate.yandex.net","tmt.tencentcloudapi.com","www2.deepl.com","w.deepl.com","immersive-translate.owenyoung.com","generativelanguage.googleapis.com","chat.openai.com","bing.com","www.bing.com","open.volcengineapi.com","fanyi.baidu.com","api.fanyi.baidu.com","api.interpreter.caiyunai.com","api-free.deepl.com","api.deepl.com","api.openl.club","openapi.youdao.com","translate.volcengine.com","api.niutrans.com","immersivetranslate.com","test-api2.immersivetranslate.com","api2.immersivetranslate.com","config.immersivetranslate.com","app.immersivetranslate.com","dash.immersivetranslate.com","api.immersivetranslate.com","immersive-translate.deno.dev","www.googleapis.com","www.google-analytics.com","translate-pa.googleapis.com","api.cognitive.microsofttranslator.com","api.groq.com","api.x.ai","api.papago-chrome.com","api.openai.com","api.interpreter.caiyunai.com","api.cognitive.microsofttranslator.com","aidemo.youdao.com","dict.youdao.com","openai.azure.com","mt.aliyuncs.com","subhub.weixin.so","api.anthropic.com","localhost","127.0.0.1","ai.immersivetranslate.com","test-ai.immersivetranslate.com","openrouter.ai","dashscope.aliyuncs.com","api.deepseek.com","aip.baidubce.com","ark.cn-beijing.volces.com","hunyuan.tencentcloudapi.com","public-beta-api.siliconflow.cn","api.siliconflow.cn","open.bigmodel.cn","store.immersivetranslate.com"]',MOCK:"0",DEBUG:"0",INSTALL_FROM:"chrome_zip"};var R=class{from;to;constructor(e){this.from=e.from,this.to=e.to}sendMessages(e){let n={type:e.type,data:e.data,id:e.id||this.getRandomId(),isAsync:!1};globalThis.document.dispatchEvent(new CustomEvent(this.to,{detail:JSON.stringify(n)}))}getRandomId(){return Math.random()*1e17+new Date().getTime()}sendAsyncMessages({type:e,data:n}){return new Promise(t=>{let a=this.handleMessages(S=>{S.id===l&&(t(S.data),a())}),l=this.getRandomId(),u={type:e,data:n,id:l,isAsync:!0};globalThis.document.dispatchEvent(new CustomEvent(this.to,{detail:JSON.stringify(u)}))})}handleMessageOnce(e){return new Promise(n=>{let t=this.handleMessage(e,a=>{n(a.data),t()})})}handleMessage(e,n){return this.handleMessages(t=>{t.type===e&&n(t)})}handleMessages(e){let n=t=>{let l=JSON.parse(t.detail||"{}");l&&typeof l=="object"&&e(l)};return globalThis.document.addEventListener(this.from,n),()=>{globalThis.document.removeEventListener(this.from,n)}}},W={get(r,e,n){return e in r?(...t)=>{let a=r[e];return typeof a=="function"?a.apply(r,t):Reflect.get(r,e,n)}:t=>r.sendAsyncMessages({type:e,data:t})}};var V="imt-subtitle-event-to-content-script",z="imt-subtitle-event-to-inject",oe=new R({from:V,to:z}),f=new R({from:z,to:V}),P=new Proxy(f,W),Re=new Proxy(oe,W);function _(r){if(!r)return null;try{let e=r;return r.startsWith("//")?e=globalThis.location.protocol+r:r.startsWith("/")?e=`${globalThis.location.protocol}//${globalThis.location.host}${r}`:r.startsWith("http")||(e=`${globalThis.location.protocol}//${r}`),new URL(e).toString()}catch(e){return console.error(e),r}}var i=class{content=P;config;constructor(e){this.config=e,f.handleMessages(async({type:n,id:t,data:a})=>{let l=this[n];if(!l)return;let u=l.apply(this,[a]);u instanceof Promise&&(u=await u),f.sendMessages({id:t,data:u})})}triggerSubtitle(e){}async translateSubtitle(e){let n=await this.content.requestSubtitle({url:_(e._url)});if(n){if(this.config.responseType=="document"){let a=new DOMParser().parseFromString(n,"text/xml");Object.defineProperty(e,"responseXML",{value:a,writable:!1}),Object.defineProperty(e,"response",{value:a,writable:!1});return}let t=n;(e.responseType=="arraybuffer"||this.config.responseType=="arraybuffer")&&typeof n=="string"&&(t=new TextEncoder().encode(n).buffer),Object.defineProperty(e,"responseText",{value:t,writable:!1}),Object.defineProperty(e,"response",{value:t,writable:!1})}}async translateSubtitleWithResponse(e,n){return await this.content.requestSubtitle({url:_(e),responseText:n})}startRequestSubtitle(e){this.content.startRequestSubtitle({url:_(e)})}subtitleRequestError(e){this.content.subtitleRequestError({...e,url:_(e.url)})}async isOnlyResponse(){return this.config.hookType.includes("xhr_response")}async translateSubtitleWithFetch(e,n){let t={...n},a;return typeof e=="string"?a={url:e,method:"GET",headers:{}}:a=await ae(e),t?.body&&(t.body=J(t.body)),this.content.requestSubtitle({fetchInfo:JSON.stringify({input:a,options:t})})}async getVideoMeta(e){}getCurrentTime(){return null}getCurrentDuration(){return null}isSubtitleRequest(e){return!this.config||!this.config.subtitleUrlRegExp||!e?!1:new RegExp(this.config.subtitleUrlRegExp).test(e||"")}};function ae(r){if(r instanceof URL)return{url:r.href,method:"GET",headers:{}};let e=r.clone(),n={url:r.url,method:r.method,headers:Object.fromEntries(r.headers.entries())};if(e.body){let t=J(e.body);if(e.body!==t)return e.text().then(a=>(n.body=a,n));n.body=t}return Promise.resolve(n)}function J(r){if(!r)return r;if(r instanceof FormData||r instanceof URLSearchParams){let e={};for(let[n,t]of r.entries())e[n]=t;return e._formatBodyType="FormData",e}return r}var E=class extends i{timer=null;triggerSubtitle({force:e}){setTimeout(()=>{if(this.config?.subtitleButtonSelector){let n=document.querySelector(this.config.subtitleButtonSelector);if(n){let t=n.getAttribute("aria-pressed")==="true";t&&e?(n.click(),setTimeout(()=>{n.click()},100)):t||n.click();return}}if(this.config?.videoPlayerSelector){let n=document.querySelector(this.config.videoPlayerSelector);n?.toggleSubtitles(),setTimeout(()=>{n?.toggleSubtitles()},100)}},1e3)}async getVideoMeta(){if(!this.config.videoPlayerSelector)return null;try{return await this.sleep(100),document.querySelector(this.config.videoPlayerSelector)?.getPlayerResponse()}catch{return null}}async isOnlyResponse(){let e=await super.isOnlyResponse();return!e||(await this.getVideoMeta())?.videoDetails?.isLive?!1:e}getCurrentTime(){try{return this.config.videoPlayerSelector?document.querySelector(this.config.videoPlayerSelector)?.getCurrentTime():null}catch{return null}}getCurrentDuration(){try{return this.config.videoPlayerSelector?document.querySelector(this.config.videoPlayerSelector)?.getDuration():null}catch{return null}}sleep(e){return new Promise(n=>{setTimeout(()=>{n(null)},e)})}};var C=class extends i{timer=null;videoMeta={};lastVideoMeta=null;constructor(e){super(e),this.hookJSON()}hookJSON(){let e=JSON.parse;JSON.parse=n=>{let t=e(n);try{t&&t.result&&t.result.timedtexttracks&&t.result.movieId&&(this.videoMeta[t.result.movieId]=t.result,this.lastVideoMeta=t.result)}catch(a){console.log(a)}return t}}getVideoMeta(e){return this.lastVideoMeta}};var I=class extends i{timer=null;videoMeta={};constructor(e){super(e),this.hookJSON()}hookJSON(){let e=JSON.parse;JSON.parse=n=>{let t=e(n);try{t?.asset?.captions?.length?this.videoMeta[t.id]=t?.asset:t?.previews&&t?.course&&t?.previews?.forEach(a=>{this.videoMeta[a.id]=a})}catch(a){console.error(a)}return t}}getVideoMeta(e){return this.videoMeta[e]}};var A=class extends i{timer=null;videoMeta={};constructor(e){super(e),this.hookJSON()}hookJSON(){let e=JSON.parse;JSON.parse=n=>{let t=e(n);try{if(t?.stream?.sources?.length&&t?.stream?.sources[0]?.complete?.url){let a=window.location.pathname.split("/");a.length>2&&a[a.length-2]==="video"&&(this.videoMeta[a[a.length-1]]=t.stream.sources[0].complete.url)}}catch(a){console.error(a)}return t}}getVideoMeta(e){return this.videoMeta[e]}};var L=class extends i{constructor(e){super(e)}async translateSubtitleWithFetch(e,n){this.main(e,n)}async main(e,n){let t=globalThis.__originalFetch;if(!t)return;let a=e;e instanceof Request&&(a=e.clone());let l=await t(a,n);if(!l.ok)return;let u=await l.json();u.transcripts_urls&&this.requestSubtitle(u.transcripts_urls)}async requestSubtitle(e){await d(),await this.content.requestSubtitle(e)}};var k=class extends i{constructor(e){super(e)}lang="";async translateSubtitleWithFetch(e,n){this.main(e,n)}async main(e,n){let t=globalThis.__originalFetch;if(!t)return;let a=this.getUrl(e);return/textstream_/.test(a)?this.parseLang(a):this.parseAllSubs(e,n,t)}getUrl(e){return e.toString()}async parseLang(e){let t=e.match(/textstream_(\w+)=/)?.[1];return!t||t==this.lang||(this.lang=t,await d(),this.content.changeLang(t)),null}async parseAllSubs(e,n,t){if(!t)return;let a=e;e instanceof Request&&(a=e.clone());let l=await t(a,n);if(!l.ok)return;let u=await l.json();u.text_track_urls&&this.requestSubtitle(u.text_track_urls)}async requestSubtitle(e){await d(),await this.content.requestSubtitle(e)}};var{Deno:Q}=globalThis,ie=typeof Q?.noColor=="boolean"?Q.noColor:!0,se=!ie;function O(r,e){return{open:`\x1B[${r.join(";")}m`,close:`\x1B[${e}m`,regexp:new RegExp(`\\x1b\\[${e}m`,"g")}}function w(r,e){return se?`${e.open}${r.replace(e.regexp,e.open)}${e.close}`:r}function U(r){return w(r,O([2],22))}function D(r){return w(r,O([31],39))}function B(r){return w(r,O([32],39))}function $(r){return w(r,O([33],39))}var Ye=new RegExp(["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|"),"g");function M(){return typeof process>"u"&&typeof Deno<"u"?Deno.env.toObject():g}var H=M();function T(){return H.PROD==="1"}function F(){return H.PROD_API==="1"}function Y(){if(H.IMMERSIVE_TRANSLATE_SAFARI==="1")return!0;if(typeof globalThis.immersiveTranslateBrowserAPI<"u"&&globalThis.immersiveTranslateBrowserAPI.runtime&&globalThis.immersiveTranslateBrowserAPI.runtime.getManifest){let e=globalThis.immersiveTranslateBrowserAPI.runtime.getManifest();return!!(e&&e._isSafari)}else return!1}var tt=M().PROD==="1",nt=M().PROD!=="1";var o="immersiveTranslate",b="Immersive Translate",s="immersive-translate",X="imt",ue="immersivetranslate";var p="immersivetranslate.com",ge=`https://config.${p}/`,st=`https://app.${p}/`,c=T()||F()?`https://${p}/`:`https://test.${p}/`,N=`https://dash.${p}/`,lt=T()||F()?`https://api2.${p}/`:`https://test-api2.${p}/`,ut=T()||F()?`https://ai.${p}/`:`https://test-ai.${p}/`,gt=`https://assets.${ue}.cn/`,ce=c+"accounts/login?from=plugin",Z=c+"profile/",m=c+"auth/pricing/",x=c+"pricing/";Y()&&(m=c+"accounts/safari-iap/",x=c+"accounts/safari-iap/");var ct=T()?`https://onboarding.${p}/`:`https://test-onboarding.${p}/`,ee=`https://github.com/${s}/${s}/`,pt=`https://s.${p}/`;var mt=o+"DeeplGlobalState",dt=o+"BingGlobalState",bt=o+"YandexGlobalState",ft=o+"BaiduQianfanGlobalConfigStorageKey",xt=o+"SiliconCloudGlobalConfigStorageKey",Tt=o+"ZhipuGlobalConfigStorageKey";var ht=o+"GoogleAccessToken",St=o+"AuthFlow",yt=s+"-config-latest.json",Rt=o+"AuthState",_t=o+"IframeMessage",Mt=o+"WaitForRateLimit",vt=o+"DocumentMessageAsk",Pt=o+"DocumentMessageTellThirdParty",Et=o+"showError",Ct=o+"showModal",It=o+"showToast",At=o+"DocumentMessageThirdPartyTell",Lt=o+"DocumentMessageEventUpload",kt=o+"DocumentMessageTypeStopJsSDK",Ot=o+"DocumentMessageHandler",wt=o+"DocumentSetFloatBallActive",Ut=`${o}Share`,Dt=`${o}ShowFloatBallGuide`,Bt=`${o}ShowPopupModalGuide`,Ft=o+"DocumentMessageTempEnableSubtitleChanged",Nt=o+"DocumentMessageUpdateQuickButtonAiSubtitle",Gt=`${o}ToggleMouseHoverTranslateDirectly`,qt=`${o}ReqDraft`,Wt=`${o}ResDraft`,$t=`${o}Container`,Ht=`${o}SpecifiedContainer`;var Kt=`${o}PageTranslatedStatus`,jt=`${o}MangaTranslatedStatus`,Vt=`${o}PageUrlChanged`,zt=`${o}ReceiveCommand`,Jt=o+"LastUseMouseHoverTime",Qt=o+"LastUseInputTime",Yt=o+"LastUseManualTranslatePageTime",Xt=`${o}PopupReceiveMessage`,Zt=o+"DocumentMessageEventTogglePopup",en=`${ge}default_config.json`,tn=`${o}Mark`,nn=`${o}Root`,rn=`${o}Walked`,on=`data-${s}-walked`,an=`${o}Paragraph`,sn=`data-${s}-paragraph`,ln=`data-${s}-translation-element-mark`,un=`${o}TranslationElementMark`,gn=`${o}TranslatedMark`,cn=`${s}-input-injected-css`,pn=`${o}LoadingId`,mn=`data-${s}-loading-id`,dn=`${o}ErrorId`,bn=`data-${s}-error-id`,fn=`${o}AtomicBlockMark`,xn=`${o}ExcludeMark`,Tn=`data-${s}-exclude-mark`,hn=`${o}StayOriginalMark`,Sn=`${o}PreWhitespaceMark`,yn=`${o}InlineMark`,Rn=`${o}BlockMark`,_n=`${o}Left`,Mn=`${o}Right`,vn=`${o}Width`,Pn=`${o}Height`,En=`${o}Top`,Cn=`${o}FontSize`;var In=`${o}GlobalStyleMark`;var An=`${s}-target-wrapper`,Ln=`${s}-pdf-target-container`,kn=`${s}-target-inner`,On=`${s}-source-wrapper`,wn=`${s}-target-translation-block-wrapper`,Un=`${s}-root-translation-theme`,Dn=`${o}RootTranslationTheme`,Bn=`${s}-target-translation-vertical-block-wrapper`,Fn=`${s}-target-translation-pdf-block-wrapper`,Nn=`${s}-target-translation-pre-whitespace`,Gn=`${s}-target-translation-inline-wrapper`;var qn=["https://immersive-translate.owenyoung.com/options/","https://immersive-translate.owenyoung.com/auth-done/",N,N+"auth-done/","http://localhost:8000/dist/userscript/options/","http://localhost:8000/auth-done/","http://192.168.50.9:8000/dist/userscript/options/","http://192.168.31.51:8000/dist/userscript/options/","http://192.168.1.72:8000/dist/userscript/options/","https://www.deepl.com/translator","translate.google.com","http://localhost:8000/options/","http://192.168.50.9:8000/options/","http://192.168.31.51:8000/options/","http://192.168.1.72:8000/options/"];var Wn=c+"docs/communities/",$n=ee+"issues/1809",Hn=ee+"issues/1179",Kn={type:o+"ChildFrameToRootFrameIdentifier"};var jn=T()?N+"#general":"http://localhost:8000/dist/userscript/options/#general";var pe=N+"#general",Vn=c+"accounts/login?from=plugin&return_url="+encodeURIComponent(pe),zn=ce+"&utm_source=extension&utm_medium=extension&utm_campaign=error_modal",me=c+"download/",de=c+"topup?type=open_ai&",be=c+"topup?type=deepl&",Jn=c+"topup?type=comics&",Qn=x+"?utm_source=extension&utm_medium=extension&utm_campaign=popup_more",Yn=m+"?utm_source=extension&utm_medium=extension&utm_campaign=manga_guide",Xn=me+"?utm_source=extension&utm_medium=extension&utm_campaign=options_nav",Zn=x+"?utm_source=extension&utm_medium=extension&utm_campaign=popup_footer",er=x+"?utm_source=extension&utm_medium=extension&utm_campaign=error_modal",tr=x+"?utm_source=extension&utm_medium=extension&utm_campaign=max_",nr=x+"?utm_source=extension&utm_medium=extension&utm_campaign=float_ball",rr=Z+"?utm_source=extension&utm_medium=extension&utm_campaign=error_modal",or=m+"?utm_source=extension&utm_medium=extension&utm_campaign=subtitle_download",ar=m+"?utm_source=extension&utm_medium=extension&utm_campaign=error_modal_ai_subtitle",ir=de+"utm_source=extension&utm_medium=extension&utm_campaign=error_modal",sr=be+"utm_source=extension&utm_medium=extension&utm_campaign=error_modal",lr=c+"topup?utm_source=extension&utm_medium=extension&utm_campaign=error_modal",ur=x+"?utm_source=extension&utm_medium=extension&utm_campaign=option_sync_config",gr=Z+"?utm_source=extension&utm_medium=extension&utm_campaign=error_modal&upgradeFromTrial=true",cr=m+"?utm_source=extension&utm_medium=extension&utm_campaign=manga_intro",pr=m+"?utm_source=extension&utm_medium=extension&utm_campaign=image_intro",mr=m+"?utm_source=extension&utm_medium=extension&utm_campaign=image_client",dr=m+"?utm_source=extension&utm_medium=extension&utm_campaign=yt_ai_asr",br=m+"?utm_source=extension&utm_medium=extension&utm_campaign=",fr=c+"docs/usage/",xr=c+"docs/communities/",v=M().TRANSLATE_FILE_URL,Tr=v+"?utm_source=extension&utm_medium=extension&utm_campaign=options_nav",hr=v+"?utm_source=extension&utm_medium=extension&utm_campaign=float_ball",Sr=`${v}download-subtitle/`,yr=`${v}pdf-pro/`,Rr=`${v}text/`;var _r=c+"docs/usage/";var Mr=`https://analytics.${p}/collect`,vr=`https://analytics.${p}/internal`,Pr=`${c}activities/components/image-pro`;var Er=50*1e4,Cr=`[${X}-ctx-divider]`,Ir=`${X}_context_preview`;var Ar=`${o}_selection_update_params`,Lr=`data-${s}-subtitle-type`,kr=`data-${s}-ai-subtitle-url`,Or=`data-${s}-has-subtitle`;var wr=m+"?utm_source=extension&utm_medium=extension&utm_campaign=freeImageError";var h=console,K=class{#e=performance.now();reset(){this.#e=performance.now()}stop(e){let n=performance.now(),t=Math.round(n-this.#e),a=B;t>1e4?a=D:t>1e3&&(a=$),h.debug(U(b+" TIMING:"),e,"in",a(t+"ms")),this.#e=n}},j=class{#e=1;get level(){return this.#e}setLevel(e){switch(e){case"debug":this.#e=0;break;case"info":this.#e=1;break;case"warn":this.#e=2;break;case"error":this.#e=3;break;case"fatal":this.#e=4;break}}debug(...e){this.#e<=0&&h.log(U(b+" DEBUG:"),...e)}v(...e){this.#e<=0&&console.log(U(b+" VERBOSE:"),...e)}info(...e){this.#e<=1&&h.log(B(b+" INFO:"),...e)}l(...e){this.#e<=1&&console.log(B(b+" TEMP INFO:"),...e)}warn(...e){this.#e<=2&&h.warn($(b+" WARN:"),...e)}error(...e){this.#e<=3&&h.error(D(b+" ERROR:"),...e)}fatal(...e){this.#e<=4&&h.error(D(b+" FATAL:"),...e)}timing(){return this.level===0?new K:{reset:()=>{},stop:()=>{}}}},te=new j;var ne={hookRequest:()=>{}};async function fe(){let r=await f.sendAsyncMessages({type:"getConfig"});if(!r)return;let n={youtube:E,netflix:C,webvtt:i,khanacademy:i,udemy:I,general:i,ebutt:i,hulu:L,mubi:k,disneyplus:A,"fmp4.xml":i,multi_attach_vtt:i,twitter:i,subsrt:i,xml:i,text_track_dynamic:i,av:i}[r.type||""];if(!n)return;let t=new n(r);ne.hookRequest(t,r)}ne.hookRequest=(r,e)=>{if(e.hookType.includes("xhr")){let n=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send,a=function(){return this._url=arguments[1],n.apply(this,arguments)},l=async function(){let u=this._url,S=r.isSubtitleRequest(u);return!u||!S?t.apply(this,arguments):(await r.isOnlyResponse()?(r.startRequestSubtitle(u),this.onreadystatechange=async()=>{let y=XMLHttpRequest.DONE;typeof y>"u"&&(y=4),this.readyState===y&&this.status===429&&r.subtitleRequestError({url:u,responseStatus:this.status}),this.readyState===y&&this.status===200&&await d()&&r.translateSubtitleWithResponse(u,this.responseText)}):await d()&&await r.translateSubtitle(this),t.apply(this,arguments))};Object.defineProperty(XMLHttpRequest.prototype,"open",{value:a,writable:!0}),Object.defineProperty(XMLHttpRequest.prototype,"send",{value:l,writable:!0})}if(e.hookType.includes("fetch")){let n=globalThis.fetch;globalThis.__originalFetch=n,globalThis.fetch=async function(t,a){let l=typeof t=="string"?t:t.url||t.href;if(!r.isSubtitleRequest(l))return n(t,a);if(await d()){let q=await r.translateSubtitleWithFetch(t,a);return q?new Response(q):n(t,a)}return n(t,a)}}};var G=!1;function d(){if(!G){let r=f.handleMessageOnce("contentReady").then(()=>(G=!0,!0));return P.isContentReady(),Promise.race([r,new Promise(e=>{setTimeout(()=>{G||te.warn("waitPluginDone timeout"),e(!1)},5e3)})])}return Promise.resolve(G)}d();fe();})();
